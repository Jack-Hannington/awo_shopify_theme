<div class="page-width">
    <table style="width:100%;">
      <thead>
        <tr>
          <th>Image</th>
          <th>Title</th>
          <th>Quantity</th>
          <th>Amount</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {%- for parent_item in cart.items -%}
          <script>
          console.log({{ parent_item | json }})
          </script>
      
          {% unless parent_item.properties.Variant == blank %}
            <!-- Parent Product Row -->
            <tr>
              <td><img src="{{ parent_item.image | img_url: 'small' }}" alt="{{ parent_item.product.title }}" /></td>
              {% comment %} insert shopify image {% endcomment %}
              <td>{{ parent_item.product.title }}</td>
              <td> 
                <div class="quantity-selector">
                  <button class="quantity-decrease" data-key="{{ parent_item.key }}">-</button>
                  <input type="number" class="quantity-input" data-key="{{ parent_item.key }}" value="{{ parent_item.quantity }}" min="1" readonly />
                  <button class="quantity-increase" data-key="{{ parent_item.key }}">+</button>
                </div>
              </td>
              <td>{{ parent_item.final_line_price | money }}</td>
              <td>
                <div style="width:20px;" class="remove-item" data-key="{{ parent_item.key }}">
                  {% render 'icon-remove' %}
                </div>
              </td>
            </tr>
      
            <!-- Loop through service items for this parent -->
            {%- for service_item in cart.items -%}
              {% if service_item.properties.Parent == parent_item.properties.Variant %}
                <tr>
                  <td><img src="{{ service_item.image | img_url: 'small' }}" alt="{{ service_item.product.title }}" /></td>
                  <td>-- {{ service_item.product.title }}</td>
                  <td>
                    <div class="quantity-selector">
                      <button class="quantity-decrease" data-key="{{ service_item.key }}">-</button>
                      <input type="number" class="quantity-input" data-key="{{ service_item.key }}" value="{{ service_item.quantity }}" min="1" readonly />
                      <button class="quantity-increase" data-key="{{ service_item.key }}">+</button>
                    </div>
                  </td>
                  <td>{{ service_item.final_line_price | money }}</td>
                  <td>
                    <div style="width:20px;" class="remove-item" data-key="{{ service_item.key }}">
                      {% render 'icon-remove' %}
                    </div>
                  </td>
                </tr>
              {% endif %}
            {%- endfor -%}
      
            <!-- Check if there are other related services not in cart -->
            {% if parent_item.product.metafields.custom.installation_options.value %}
              {% assign installation_options = parent_item.product.metafields.custom.installation_options.value %}
              {% for option in installation_options %}
                {% assign associated_product = all_products[option.associated_product] %}
                {% assign service_in_cart = false %}
                {%- for service_item in cart.items -%}
                  {% if service_item.properties.Parent == parent_item.properties.Variant and service_item.product.id == associated_product.id %}
                    {% assign service_in_cart = true %}
                  {% endif %}
                {%- endfor -%}
                {% unless service_in_cart %}
                  <tr>
                    <td><img src="{{ associated_product.featured_image | img_url: 'small' }}" alt="{{ associated_product.title }}" /></td>
                    <td>-- {{ associated_product.title }}</td>
                    <td colspan="3">
                      <button class="add-service" data-service-id="{{ associated_product.variants.first.id }}" data-parent-id="{{ parent_item.properties.Variant }}">Add Service</button>
                    </td>
                  </tr>
                {% endunless %}
              {% endfor %}
            {% endif %}
          {% endunless %}
        {%- endfor -%}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4"><strong>Total</strong></td>
          <td><strong>{{ cart.total_price | money }}</strong></td>
        </tr>
      </tfoot>
    </table>
  </div>
  
  <script>

    

 

    document.addEventListener('DOMContentLoaded', function() {
        function updateCart(key, quantity) {
          fetch('/cart/change.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({
              id: key,
              quantity: quantity
            })
          })
          .then(response => response.json())
          .then(cart => {
            console.log(cart);
            location.reload(); // Reload the page to reflect the changes
          })
          .catch(error => console.error('Error:', error));
        }
      
        document.querySelectorAll('.quantity-decrease').forEach(function(button) {
          button.addEventListener('click', function() {
            const key = this.getAttribute('data-key');
            const input = this.closest('.quantity-selector').querySelector('.quantity-input');
            let quantity = parseInt(input.value, 10);
      
            if (quantity > 1) {
              quantity--;
              input.value = quantity;
              updateCart(key, quantity);
            }
          });
        });
      
        document.querySelectorAll('.quantity-increase').forEach(function(button) {
          button.addEventListener('click', function() {
            const key = this.getAttribute('data-key');
            const input = this.closest('.quantity-selector').querySelector('.quantity-input');
            let quantity = parseInt(input.value, 10);
      
            quantity++;
            input.value = quantity;
            updateCart(key, quantity);
          });
        });
      
        document.querySelectorAll('.remove-item').forEach(function(button) {
          button.addEventListener('click', function() {
            const key = this.getAttribute('data-key');
      
            updateCart(key, 0);
          });
        });

        function getProductInfo(){
          fetch(window.Shopify.routes.root + "products/appliance-world-washing-machine-installation.js")
            .then(response => response.json())
            .then(product => console.log(product));
        }

        getProductInfo();
    
      });
      
      
  </script>
  