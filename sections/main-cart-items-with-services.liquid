<div class="page-width">
    <table style="width:100%;">
      <thead>
        <tr>
          <th>Image</th>
          <th>Title</th>
          <th>Quantity</th>
          <th>Amount</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {%- for parent_item in cart.items -%}
          {% unless parent_item.properties.Variant == blank %}
            <!-- Parent Product Row -->
            <tr>
              <td><img src="{{ parent_item.image | img_url: 'small' }}" alt="{{ parent_item.product.title }}" /></td>
              <td>{{ parent_item.product.title }}</td>
              <td>
                <div class="quantity-selector">
                  <button class="quantity-decrease" data-key="{{ parent_item.key }}">-</button>
                  <input type="number" class="quantity-input" data-key="{{ parent_item.key }}" value="{{ parent_item.quantity }}" min="1" readonly />
                  <button class="quantity-increase" data-key="{{ parent_item.key }}">+</button>
                </div>
              </td>
              <td>{{ parent_item.final_line_price | money }}</td>
              <td>
                <div style="width:20px;" class="remove-item" data-key="{{ parent_item.key }}">
                  {% render 'icon-remove' %}
                </div>
              </td>
            </tr>
  
            <!-- Loop through service items for this parent -->
            {%- for service_item in cart.items -%}
              {% if service_item.properties.Parent == parent_item.properties.Variant %}
                <tr>
                  <td><img src="{{ service_item.image | img_url: 'small' }}" alt="{{ service_item.product.title }}" /></td>
                  <td>-- {{ service_item.product.title }}</td>
                  <td>
                    <div class="quantity-selector">
                      <button class="quantity-decrease" data-key="{{ service_item.key }}">-</button>
                      <input type="number" class="quantity-input" data-key="{{ service_item.key }}" value="{{ service_item.quantity }}" min="1" readonly />
                      <button class="quantity-increase" data-key="{{ service_item.key }}">+</button>
                    </div>
                  </td>
                  <td>{{ service_item.final_line_price | money }}</td>
                  <td>
                    <div style="width:20px;" class="remove-item" data-key="{{ service_item.key }}">
                      {% render 'icon-remove' %}
                    </div>
                  </td>
                </tr>
              {% endif %}
            {%- endfor -%}
          {% endunless %}
        {%- endfor -%}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4"><strong>Total</strong></td>
          <td><strong>{{ cart.total_price | money }}</strong></td>
        </tr>
      </tfoot>
    </table>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        function updateCart(key, quantity) {
          fetch('/cart/change.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({
              id: key,
              quantity: quantity
            })
          })
          .then(response => response.json())
          .then(cart => {
            console.log(cart);
            location.reload(); // Reload the page to reflect the changes
          })
          .catch(error => console.error('Error:', error));
        }
      
        document.querySelectorAll('.quantity-decrease').forEach(function(button) {
          button.addEventListener('click', function() {
            const key = this.getAttribute('data-key');
            const input = this.closest('.quantity-selector').querySelector('.quantity-input');
            let quantity = parseInt(input.value, 10);
      
            if (quantity > 1) {
              quantity--;
              input.value = quantity;
              updateCart(key, quantity);
            }
          });
        });
      
        document.querySelectorAll('.quantity-increase').forEach(function(button) {
          button.addEventListener('click', function() {
            const key = this.getAttribute('data-key');
            const input = this.closest('.quantity-selector').querySelector('.quantity-input');
            let quantity = parseInt(input.value, 10);
      
            quantity++;
            input.value = quantity;
            updateCart(key, quantity);
          });
        });
      
        document.querySelectorAll('.remove-item').forEach(function(button) {
          button.addEventListener('click', function() {
            const key = this.getAttribute('data-key');
      
            updateCart(key, 0);
          });
        });
      });
      
      
  </script>
  